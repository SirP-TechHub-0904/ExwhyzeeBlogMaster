@page
@model AdminUI.Areas_Admin_Pages_MediaFiles.IndexModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Media Manager";
}

<section class="content-header">
    <h2>Media Manager (@Model.MediaFiles.Count())</h2>
</section>

<section class="content">

    <!-- Upload Area -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Upload Files</h3>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="fileInput" class="form-label fw-bold">Upload Files</label>
                    <input type="file" id="fileInput" name="Files" class="form-control" multiple onchange="previewFiles(event)" />
                </div>

                <!-- Preview Section -->
                <div id="preview-container" class="mt-3 row g-3"></div>

                <button type="submit" class="btn btn-primary mt-3">Upload</button>
            </form>

        </div>
    </div>

    <!-- Media Grid -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Uploaded Files</h3>
        </div>
        <div class="card-body">
            <div class="row">
                @foreach (var media in Model.MediaFiles)
                {
                    <div class="col-md-3 col-sm-4 mb-3">
                        <div class="card shadow-sm border">
                            <a href="@media.Url" target="_blank">
                                <img src="@media.Url" class="card-img-top" style="height: 150px; object-fit: cover;" />
                            </a>
                            <div class="card-body p-2 text-center">
                                <p class="small text-truncate mb-2 fw-semibold">@media.AltText</p>

                                <!-- Copy Link Button -->
                                <div class="d-grid gap-2 mb-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm copy-btn"
                                            data-url="@($"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}{media.Url}")">
                                        <i class="bi bi-clipboard"></i> Copy Link
                                    </button>
                                </div>

                                <!-- Add to Post Button -->
                                <div class="d-grid gap-2 mb-2">
                                    <a asp-page="./AddToPost" asp-route-id="@media.Id"
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-plus-circle"></i> Add to Post
                                    </a>
                                </div>

                                <!-- Delete Button -->
                                <form method="post" asp-page-handler="Delete">
                                    <input type="hidden" name="id" value="@media.Id" />
                                    <button type="submit" class="btn btn-danger btn-sm w-100">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                }
            </div>

            <!-- Pagination -->
            @if (Model.TotalCount > Model.PageSize)
            {
                int totalPages = (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize);
                <nav>
                    <ul class="pagination">
                        @for (int i = 1; i <= totalPages; i++)
                        {
                            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                <a class="page-link" href="?PageNumber=@i">@i</a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        </div>
    </div>

</section>

@section Scripts {
    <script>
        function previewFiles(event) {
            const files = event.target.files;
            const container = document.getElementById("preview-container");
            container.innerHTML = ""; // Clear previous previews

            Array.from(files).forEach(file => {
                const url = URL.createObjectURL(file);

                let previewElement;
                if (file.type.startsWith("image")) {
                    previewElement = `<div class="col-4"><img src="${url}" class="img-thumbnail" style="max-width: 100%;"></div>`;
                } else if (file.type.startsWith("video")) {
                    previewElement = `<div class="col-4"><video src="${url}" controls style="max-width: 100%;"></video></div>`;
                } else {
                    previewElement = `<div class="col-4"><p>${file.name}</p></div>`;
                }

                container.innerHTML += previewElement;
            });
        }
    </script>

    <script>
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                navigator.clipboard.writeText(this.dataset.url).then(() => {
                    alert("Copied: " + this.dataset.url);
                });
            });
        });
    </script>


}